<div class="max-w-[1400px] mx-auto px-4 sm:px-6 py-6 sm:py-10">
  <!-- Back button -->
  <div class="mb-4 sm:mb-6">
    <%= link_to scores_path, class: "mm-button mm-button-secondary inline-flex items-center gap-2 text-xs px-3 sm:px-4 py-2" do %>
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
      </svg>
      <%= t('score.back') %>
    <% end %>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8">
    <!-- Score Preview -->
    <div class="mm-card overflow-hidden h-[50vh] sm:h-[60vh] lg:h-[700px]">
      <% if @score.preview_image.attached? %>
        <!-- High-res preview (1200px) -->
        <%= image_tag @score.preview_image,
            alt: @score.title,
            class: "w-full h-full object-contain bg-[var(--color-bg)]"
        %>
      <% elsif @score.thumbnail_image.attached? %>
        <!-- Thumbnail fallback (400px) -->
        <%= image_tag @score.thumbnail_image,
            alt: @score.title,
            class: "w-full h-full object-contain bg-[var(--color-bg)]"
        %>
      <% elsif @score.has_pdf? %>
        <!-- No preview available - show link to open PDF -->
        <div class="w-full h-full bg-[var(--color-bg)] flex flex-col items-center justify-center gap-6 p-8">
          <div class="text-[120px] text-[var(--color-border-subtle)]">üìÑ</div>
          <div class="text-center">
            <p class="text-sm font-semibold text-[var(--color-text-muted)] mb-4">
              <%= t('score.preview_not_generated') %>
            </p>
            <%= link_to file_score_path(@score, 'pdf'),
                target: "_blank",
                rel: "noopener noreferrer",
                class: "mm-button mm-button-primary inline-flex items-center gap-2 text-xs px-6 py-3" do %>
              <span><%= t('score.open_pdf') %> ‚Üó</span>
            <% end %>
          </div>
        </div>
      <% else %>
        <!-- No PDF at all -->
        <div class="w-full h-full bg-[var(--color-bg)] flex items-center justify-center">
          <div class="text-[140px] text-[var(--color-border-subtle)]">‚ô™</div>
        </div>
      <% end %>
    </div>

    <!-- Score Details -->
    <div class="space-y-5">
      <!-- Title & Composer Header -->
      <header>
        <h1 class="text-2xl sm:text-3xl lg:text-4xl font-[var(--font-family-display)] text-[var(--color-primary)] mb-2 leading-tight font-black uppercase tracking-tight">
          <%= @score.title %>
        </h1>

        <div class="flex flex-wrap items-center gap-2 sm:gap-3">
          <p class="text-sm sm:text-base text-[var(--color-text-muted)] font-semibold">
            <%= @score.composer.presence || t('score.unknown_composer') %>
          </p>
          <% if @score.source.present? %>
            <span class="mm-badge-source mm-badge-<%= @score.source %>">
              <%= @score.source.upcase %>
            </span>
          <% end %>
        </div>
      </header>

      <!-- Description (if present) -->
      <% if @score.description.present? %>
        <div class="score-description">
          <p class="text-sm text-[var(--color-text-muted)] leading-relaxed italic">
            "<%= @score.description %>"
          </p>
        </div>
      <% end %>

      <!-- Music Details Card -->
      <div class="mm-card p-4 sm:p-5">
        <h3 class="text-sm font-[var(--font-family-display)] text-[var(--color-primary)] mb-4 font-black uppercase tracking-tight flex items-center gap-2">
          <span class="text-[var(--color-accent)]">‚ô™</span>
          <%= t('score.music_details') %>
        </h3>
        <dl class="score-details-grid">
          <% if @score.voicing.present? %>
            <div class="score-detail-item">
              <dt><%= t('score.voicing') %></dt>
              <dd><%= @score.voicing %></dd>
            </div>
          <% end %>
          <% if @score.primary_key_signature.present? %>
            <div class="score-detail-item">
              <dt><%= t('score.key') %></dt>
              <dd><%= @score.primary_key_signature %></dd>
            </div>
          <% end %>
          <% if @score.primary_time_signature.present? %>
            <div class="score-detail-item">
              <dt><%= t('score.time') %></dt>
              <dd><%= @score.primary_time_signature %></dd>
            </div>
          <% end %>
          <% if @score.num_parts.present? && @score.num_parts > 0 %>
            <div class="score-detail-item">
              <dt><%= t('score.parts') %></dt>
              <dd><%= @score.num_parts %></dd>
            </div>
          <% end %>
          <% if @score.language.present? %>
            <div class="score-detail-item">
              <dt><%= t('score.language') %></dt>
              <dd><%= @score.language %></dd>
            </div>
          <% end %>
          <% if @score.instruments.present? %>
            <div class="score-detail-item">
              <dt><%= t('score.instruments') %></dt>
              <dd><%= @score.instruments %></dd>
            </div>
          <% end %>
          <% if @score.page_count.present? && @score.page_count > 0 %>
            <div class="score-detail-item">
              <dt><%= t('score.page_count') %></dt>
              <dd><%= @score.page_count %></dd>
            </div>
          <% end %>
          <% if @score.complexity.present? && @score.complexity > 0 %>
            <div class="score-detail-item">
              <dt><%= t('score.complexity') %></dt>
              <dd><%= t('score.complexity_scale', value: @score.complexity) %></dd>
            </div>
          <% end %>
          <% if @score.rating.present? && @score.rating > 0 %>
            <div class="score-detail-item">
              <dt><%= t('score.rating') %></dt>
              <dd><%= t('score.rating_scale', value: number_with_precision(@score.rating, precision: 1)) %></dd>
            </div>
          <% end %>
        </dl>
      </div>

      <!-- About This Score Card (CPDL-specific info) -->
      <% has_about_info = @score.editor.present? || @score.license.present? || @score.cpdl_number.present? || @score.posted_date.present? %>
      <% if has_about_info %>
        <div class="mm-card p-4 sm:p-5">
          <h3 class="text-sm font-[var(--font-family-display)] text-[var(--color-primary)] mb-4 font-black uppercase tracking-tight flex items-center gap-2">
            <span class="text-[var(--color-accent)]">‚óè</span>
            <%= t('score.about_this_score') %>
          </h3>
          <dl class="score-details-grid">
            <% if @score.cpdl_number.present? %>
              <div class="score-detail-item">
                <dt><%= t('score.cpdl_number') %></dt>
                <dd class="font-mono"><%= @score.cpdl_number %></dd>
              </div>
            <% end %>
            <% if @score.editor.present? %>
              <div class="score-detail-item">
                <dt><%= t('score.editor') %></dt>
                <dd><%= @score.editor %></dd>
              </div>
            <% end %>
            <% if @score.posted_date.present? %>
              <div class="score-detail-item">
                <dt><%= t('score.posted_date') %></dt>
                <dd><%= @score.posted_date %></dd>
              </div>
            <% end %>
            <% if @score.license.present? %>
              <div class="score-detail-item score-detail-item-full">
                <dt><%= t('score.license') %></dt>
                <dd class="text-xs"><%= @score.license %></dd>
              </div>
            <% end %>
          </dl>
        </div>
      <% end %>

      <!-- Genres/Tags -->
      <% if @score.genre_list.any? || @score.tag_list.any? %>
        <div class="flex flex-wrap gap-4">
          <% if @score.genre_list.any? %>
            <div>
              <h3 class="text-xs font-semibold text-[var(--color-text-muted)] mb-2 uppercase tracking-wide"><%= t('score.genres') %></h3>
              <div class="flex flex-wrap gap-1.5">
                <% @score.genre_list.each do |genre| %>
                  <span class="mm-badge"><%= genre %></span>
                <% end %>
              </div>
            </div>
          <% end %>
          <% if @score.tag_list.any? %>
            <div>
              <h3 class="text-xs font-semibold text-[var(--color-text-muted)] mb-2 uppercase tracking-wide"><%= t('score.tags') %></h3>
              <div class="flex flex-wrap gap-1.5">
                <% @score.tag_list.each do |tag| %>
                  <span class="mm-badge mm-badge-tag"><%= tag %></span>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- Lyrics Section -->
      <% if @score.lyrics.present? %>
        <details class="mm-card overflow-hidden lyrics-accordion">
          <summary class="p-4 sm:p-5 cursor-pointer select-none flex items-center justify-between hover:bg-[var(--color-bg-elevated)] transition-colors">
            <h3 class="text-sm font-[var(--font-family-display)] text-[var(--color-primary)] font-black uppercase tracking-tight flex items-center gap-2">
              <span class="text-[var(--color-accent)]">¬∂</span>
              <%= t('score.lyrics_text') %>
            </h3>
            <svg class="lyrics-chevron w-4 h-4 text-[var(--color-text-muted)] transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"/>
            </svg>
          </summary>
          <div class="px-4 sm:px-5 pb-4 sm:pb-5 border-t-2 border-[var(--color-border-subtle)]">
            <div class="lyrics-content pt-4 text-sm text-[var(--color-text)] leading-relaxed whitespace-pre-wrap font-serif"><%=h @score.lyrics %></div>
          </div>
        </details>
      <% end %>

      <!-- Download Actions -->
      <div class="mm-card p-4 sm:p-5">
        <h3 class="text-sm font-[var(--font-family-display)] text-[var(--color-primary)] mb-4 font-black uppercase tracking-tight flex items-center gap-2">
          <span class="text-[var(--color-accent)]">‚Üì</span>
          <%= t('score.download_files') %>
        </h3>
        <div class="space-y-2">
          <% if @score.has_mxl? %>
            <%= link_to file_score_path(@score, 'mxl', download: true), class: "mm-button mm-button-primary block w-full text-center py-3 text-xs" do %>
              <span class="inline-flex items-center gap-2">
                <span>‚Üì</span> <%= t('score.download_musicxml') %>
              </span>
            <% end %>
          <% end %>
          <% if @score.has_pdf? %>
            <%= link_to file_score_path(@score, 'pdf', download: true), class: "mm-button mm-button-secondary block w-full text-center py-3 text-xs" do %>
              <span class="inline-flex items-center gap-2">
                <span>‚Üì</span> <%= t('score.download_pdf') %>
              </span>
            <% end %>
          <% end %>
          <% if @score.has_midi? %>
            <%= link_to file_score_path(@score, 'mid', download: true), class: "mm-button mm-button-secondary block w-full text-center py-3 text-xs" do %>
              <span class="inline-flex items-center gap-2">
                <span>‚Üì</span> <%= t('score.download_midi') %>
              </span>
            <% end %>
          <% end %>
          <% unless @score.has_mxl? || @score.has_pdf? || @score.has_midi? %>
            <p class="text-xs text-[var(--color-text-muted)] text-center py-2 italic">
              No direct downloads available
            </p>
          <% end %>
        </div>
      </div>

      <!-- External Source Link -->
      <% if @score.external_url.present? %>
        <div class="external-source-link">
          <%= link_to @score.external_url, target: "_blank", rel: "noopener noreferrer", class: "mm-button mm-button-secondary block w-full text-center py-3 text-xs" do %>
            <span class="inline-flex items-center gap-2">
              <%= t('score.view_on_source', source: @score.source.upcase) %> <span>‚Üó</span>
            </span>
          <% end %>
        </div>
      <% end %>

      <!-- Stats -->
      <div class="pt-4 border-t-2 border-[var(--color-border-subtle)] flex gap-4 sm:gap-6 text-xs">
        <div>
          <span class="font-black text-[var(--color-accent)]"><%= @score.views || 0 %></span>
          <span class="text-[var(--color-text-muted)] font-semibold uppercase ml-1"><%= t('score.views') %></span>
        </div>
        <div>
          <span class="font-black text-[var(--color-accent)]"><%= @score.favorites || 0 %></span>
          <span class="text-[var(--color-text-muted)] font-semibold uppercase ml-1"><%= t('score.favs') %></span>
        </div>
      </div>
    </div>
  </div>
</div>
