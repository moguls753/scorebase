<div class="max-w-[1400px] mx-auto px-4 sm:px-6 py-6 sm:py-10">
  <!-- Back button -->
  <div class="mb-4 sm:mb-6">
    <%= link_to scores_path, class: "mm-button mm-button-secondary inline-flex items-center gap-2 text-xs px-3 sm:px-4 py-2" do %>
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
      </svg>
      <%= t('score.back') %>
    <% end %>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8">
    <!-- Score Preview -->
    <div class="mm-card overflow-hidden h-[50vh] sm:h-[60vh] lg:h-[700px]">
      <% if @score.has_preview? %>
        <%= image_tag @score.preview,
            alt: @score.title,
            class: "w-full h-full object-contain bg-[var(--color-bg)]"
        %>
      <% elsif @score.has_pdf? %>
        <!-- No preview available - show link to open PDF -->
        <div class="w-full h-full bg-[var(--color-bg)] flex flex-col items-center justify-center gap-6 p-8">
          <div class="text-[120px] text-[var(--color-border-subtle)]">üìÑ</div>
          <div class="text-center">
            <p class="text-sm font-semibold text-[var(--color-text-muted)] mb-4">
              <%= t('score.preview_not_generated') %>
            </p>
            <%= link_to file_score_path(@score, 'pdf'),
                target: "_blank",
                rel: "noopener noreferrer",
                class: "mm-button mm-button-primary inline-flex items-center gap-2 text-xs px-6 py-3" do %>
              <span><%= t('score.open_pdf') %> ‚Üó</span>
            <% end %>
          </div>
        </div>
      <% else %>
        <!-- No PDF at all -->
        <div class="w-full h-full bg-[var(--color-bg)] flex items-center justify-center">
          <div class="text-[140px] text-[var(--color-border-subtle)]">‚ô™</div>
        </div>
      <% end %>
    </div>

    <!-- Score Details -->
    <div class="space-y-5">
      <!-- Title & Composer Header -->
      <header>
        <h1 class="text-2xl sm:text-3xl lg:text-4xl font-[var(--font-family-display)] text-[var(--color-primary)] mb-2 leading-tight font-black uppercase tracking-tight">
          <%= @score.title %>
        </h1>

        <div class="flex flex-wrap items-center gap-2 sm:gap-3">
          <p class="text-sm sm:text-base text-[var(--color-text-muted)] font-semibold">
            <%= @score.composer.presence || t('score.unknown_composer') %>
          </p>
          <% if @score.source.present? %>
            <span class="mm-badge-source mm-badge-<%= @score.source %>">
              <%= @score.source.upcase %>
            </span>
          <% end %>
        </div>
      </header>

      <!-- Description (if present) -->
      <% if @score.description.present? %>
        <div class="score-description">
          <p class="text-sm text-[var(--color-text-muted)] leading-relaxed italic">
            "<%= @score.description %>"
          </p>
        </div>
      <% end %>

      <!-- Music Details Card -->
      <% has_music_details = @score.voicing.present? || @score.key_signature.present? || @score.time_signature.present? || (@score.num_parts.present? && @score.num_parts > 0) || @score.language.present? || @score.instruments.present? || (@score.page_count.present? && @score.page_count > 0) || (@score.complexity.present? && @score.complexity > 0) || (@score.rating.present? && @score.rating > 0) %>
      <% if has_music_details %>
        <div class="mm-card p-4 sm:p-5">
          <h3 class="text-sm font-[var(--font-family-display)] text-[var(--color-primary)] mb-4 font-black uppercase tracking-tight flex items-center gap-2">
            <span class="text-[var(--color-accent)]">‚ô™</span>
            <%= t('score.music_details') %>
          </h3>
          <dl class="score-details-grid">
            <% if @score.voicing.present? %>
              <div class="score-detail-item">
                <dt><%= t('score.voicing') %></dt>
                <dd><%= @score.voicing %></dd>
              </div>
            <% end %>
            <% if @score.key_signature.present? %>
              <div class="score-detail-item">
                <dt><%= t('score.key') %></dt>
                <dd><%= @score.key_signature %></dd>
              </div>
            <% end %>
            <% if @score.time_signature.present? %>
              <div class="score-detail-item">
                <dt><%= t('score.time') %></dt>
                <dd><%= @score.time_signature %></dd>
              </div>
            <% end %>
            <% if @score.num_parts.present? && @score.num_parts > 0 %>
              <div class="score-detail-item">
                <dt><%= t('score.parts') %></dt>
                <dd><%= @score.num_parts %></dd>
              </div>
            <% end %>
            <% if @score.language.present? %>
              <div class="score-detail-item">
                <dt><%= t('score.language') %></dt>
                <dd><%= @score.language %></dd>
              </div>
            <% end %>
            <% if @score.instruments.present? %>
              <div class="score-detail-item">
                <dt><%= t('score.instruments') %></dt>
                <dd><%= @score.instruments %></dd>
              </div>
            <% end %>
            <% if @score.page_count.present? && @score.page_count > 0 %>
              <div class="score-detail-item">
                <dt><%= t('score.page_count') %></dt>
                <dd><%= @score.page_count %></dd>
              </div>
            <% end %>
            <% if @score.complexity.present? && @score.complexity > 0 %>
              <div class="score-detail-item">
                <dt><%= t('score.complexity') %></dt>
                <dd><%= t('score.complexity_scale', value: @score.complexity) %></dd>
              </div>
            <% end %>
            <% if @score.rating.present? && @score.rating > 0 %>
              <div class="score-detail-item">
                <dt><%= t('score.rating') %></dt>
                <dd><%= t('score.rating_scale', value: number_with_precision(@score.rating, precision: 1)) %></dd>
              </div>
            <% end %>
          </dl>
        </div>
      <% end %>

      <!-- About This Score Card (CPDL-specific info) -->
      <% has_about_info = @score.editor.present? || @score.license.present? || @score.cpdl_number.present? || @score.posted_date.present? %>
      <% if has_about_info %>
        <div class="mm-card p-4 sm:p-5">
          <h3 class="text-sm font-[var(--font-family-display)] text-[var(--color-primary)] mb-4 font-black uppercase tracking-tight flex items-center gap-2">
            <span class="text-[var(--color-accent)]">‚óè</span>
            <%= t('score.about_this_score') %>
          </h3>
          <dl class="score-details-grid">
            <% if @score.cpdl_number.present? %>
              <div class="score-detail-item">
                <dt><%= t('score.cpdl_number') %></dt>
                <dd class="font-mono"><%= @score.cpdl_number %></dd>
              </div>
            <% end %>
            <% if @score.editor.present? %>
              <div class="score-detail-item">
                <dt><%= t('score.editor') %></dt>
                <dd><%= @score.editor %></dd>
              </div>
            <% end %>
            <% if @score.posted_date.present? %>
              <div class="score-detail-item">
                <dt><%= t('score.posted_date') %></dt>
                <dd><%= @score.posted_date %></dd>
              </div>
            <% end %>
            <% if @score.license.present? %>
              <div class="score-detail-item score-detail-item-full">
                <dt><%= t('score.license') %></dt>
                <dd class="text-xs"><%= @score.license %></dd>
              </div>
            <% end %>
          </dl>
        </div>
      <% end %>

      <!-- Genres/Tags -->
      <% if @score.genre_list.any? || @score.tag_list.any? %>
        <div class="flex flex-wrap gap-4">
          <% if @score.genre_list.any? %>
            <div>
              <h3 class="text-xs font-semibold text-[var(--color-text-muted)] mb-2 uppercase tracking-wide"><%= t('score.genres') %></h3>
              <div class="flex flex-wrap gap-1.5">
                <% @score.genre_list.each do |genre| %>
                  <span class="mm-badge"><%= genre %></span>
                <% end %>
              </div>
            </div>
          <% end %>
          <% if @score.tag_list.any? %>
            <div>
              <h3 class="text-xs font-semibold text-[var(--color-text-muted)] mb-2 uppercase tracking-wide"><%= t('score.tags') %></h3>
              <div class="flex flex-wrap gap-1.5">
                <% @score.tag_list.each do |tag| %>
                  <span class="mm-badge mm-badge-tag"><%= tag %></span>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- Lyrics Section -->
      <% if @score.lyrics.present? %>
        <details class="mm-card overflow-hidden lyrics-accordion">
          <summary class="p-4 sm:p-5 cursor-pointer select-none flex items-center justify-between hover:bg-[var(--color-bg-elevated)] transition-colors">
            <h3 class="text-sm font-[var(--font-family-display)] text-[var(--color-primary)] font-black uppercase tracking-tight flex items-center gap-2">
              <span class="text-[var(--color-accent)]">¬∂</span>
              <%= t('score.lyrics_text') %>
            </h3>
            <svg class="lyrics-chevron w-4 h-4 text-[var(--color-text-muted)] transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"/>
            </svg>
          </summary>
          <div class="px-4 sm:px-5 pb-4 sm:pb-5 border-t-2 border-[var(--color-border-subtle)]">
            <div class="lyrics-content pt-4 text-sm text-[var(--color-text)] leading-relaxed whitespace-pre-wrap font-serif"><%=h @score.lyrics %></div>
          </div>
        </details>
      <% end %>

      <!-- MIDI Player Section -->
      <% if @score.has_midi? %>
        <div class="mm-card midi-player-card"
             data-controller="midi-player"
             data-midi-player-src-value="<%= file_score_path(@score, 'mid') %>">

          <!-- Loading State -->
          <div data-midi-player-target="loading" class="flex items-center justify-center gap-3 p-6">
            <div class="midi-loading-spinner"></div>
            <span class="text-xs font-semibold text-[var(--color-text-muted)] uppercase tracking-wide"><%= t('score.loading_player') %></span>
          </div>

          <!-- Custom Player UI -->
          <div data-midi-player-target="container" class="hidden">
            <div class="midi-custom-player">
              <!-- Top row: Play button + Progress -->
              <div class="midi-player-main">
                <!-- Play/Pause Button -->
                <button type="button"
                        class="midi-play-btn"
                        data-action="click->midi-player#play"
                        aria-label="<%= t('score.play_pause') %>">
                  <!-- Play icon -->
                  <svg data-midi-player-target="playBtn" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5.14v14l11-7-11-7z"/>
                  </svg>
                  <!-- Pause icon -->
                  <svg data-midi-player-target="pauseBtn" class="w-5 h-5 hidden" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                  </svg>
                </button>

                <!-- Progress Section -->
                <div class="midi-progress-section">
                  <!-- Progress Bar -->
                  <div class="midi-progress-track"
                       data-midi-player-target="progress"
                       data-action="click->midi-player#seek">
                    <div class="midi-progress-fill" data-midi-player-target="progressBar"></div>
                  </div>

                  <!-- Time Display -->
                  <div class="midi-time-display">
                    <span data-midi-player-target="currentTime" class="midi-time">0:00</span>
                    <span class="midi-time-separator">/</span>
                    <span data-midi-player-target="totalTime" class="midi-time">0:00</span>
                  </div>
                </div>
              </div>

              <!-- Volume Control -->
              <div class="midi-volume-control">
                <svg data-midi-player-target="volumeIcon" class="midi-volume-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                </svg>
                <input type="range"
                       class="midi-volume-slider"
                       min="0"
                       max="1"
                       step="0.05"
                       value="0.8"
                       data-midi-player-target="volumeSlider"
                       data-action="input->midi-player#updateVolume"
                       aria-label="<%= t('score.volume') %>">
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Download Actions -->
      <% if @score.has_mxl? || @score.has_pdf? || @score.has_midi? %>
        <div class="mm-card p-4 sm:p-5">
          <h3 class="text-sm font-[var(--font-family-display)] text-[var(--color-primary)] mb-4 font-black uppercase tracking-tight flex items-center gap-2">
            <span class="text-[var(--color-accent)]">‚Üì</span>
            <%= t('score.download_files') %>
          </h3>
          <div class="space-y-2">
            <% if @score.has_mxl? %>
              <div class="mm-tooltip-wrap">
                <%= link_to file_score_path(@score, 'mxl', download: true), class: "mm-button mm-button-primary block w-full text-center py-3 text-xs" do %>
                  <span class="inline-flex items-center gap-2">
                    <span>‚Üì</span> <%= t('score.download_mxl') %>
                  </span>
                <% end %>
                <span class="mm-tooltip"><%= t('score.mxl_hint') %></span>
              </div>
            <% end %>
            <% if @score.has_pdf? %>
              <%= link_to file_score_path(@score, 'pdf', download: true), class: "mm-button mm-button-secondary block w-full text-center py-3 text-xs" do %>
                <span class="inline-flex items-center gap-2">
                  <span>‚Üì</span> <%= t('score.download_pdf') %>
                </span>
              <% end %>
            <% end %>
            <% if @score.has_midi? %>
              <%= link_to file_score_path(@score, 'mid', download: true), class: "mm-button mm-button-secondary block w-full text-center py-3 text-xs" do %>
                <span class="inline-flex items-center gap-2">
                  <span>‚Üì</span> <%= t('score.download_midi') %>
                </span>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- External Source Link -->
      <% if @score.external_url.present? %>
        <div class="external-source-link">
          <%= link_to @score.external_url, target: "_blank", rel: "noopener noreferrer", class: "mm-button mm-button-secondary block w-full text-center py-3 text-xs" do %>
            <span class="inline-flex items-center gap-2">
              <%= t('score.view_on_source', source: @score.source.upcase) %> <span>‚Üó</span>
            </span>
          <% end %>
        </div>
      <% end %>

      <!-- Stats -->
      <% if (@score.views.present? && @score.views > 0) || (@score.favorites.present? && @score.favorites > 0) %>
        <div class="pt-4 border-t-2 border-[var(--color-border-subtle)] flex gap-4 sm:gap-6 text-xs">
          <% if @score.views.present? && @score.views > 0 %>
            <div>
              <span class="font-black text-[var(--color-accent)]"><%= @score.views %></span>
              <span class="text-[var(--color-text-muted)] font-semibold uppercase ml-1"><%= t('score.views') %></span>
            </div>
          <% end %>
          <% if @score.favorites.present? && @score.favorites > 0 %>
            <div>
              <span class="font-black text-[var(--color-accent)]"><%= @score.favorites %></span>
              <span class="text-[var(--color-text-muted)] font-semibold uppercase ml-1"><%= t('score.favs') %></span>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>
