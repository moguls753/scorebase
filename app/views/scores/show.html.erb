<%# SEO Meta Tags %>
<% content_for :title do %><%= @score.title %><%= " - #{@score.composer}" if @score.composer.present? %> | ScoreBase<% end %>
<% content_for :meta_description do %><%= t('hub.composer_page_description', name: @score.composer || 'Unknown', count: 1).gsub(/\d+ /, '') %> <%= @score.title %>.<% end %>
<% content_for :og_type, 'music.song' %>
<% content_for :og_image, @score.thumbnail if @score.has_thumbnail? %>

<%# JSON-LD Structured Data for MusicComposition %>
<% content_for :json_ld do %>
  <%= render "scores/json_ld", score: @score %>
<% end %>

<div class="score-show-container">
  <%# ═══════════════════════════════════════════════════════════════
      HEADER: Back Button + Title/Composer Masthead
      ═══════════════════════════════════════════════════════════════ %>
  <header class="score-show-header">
    <%= link_to root_path, class: "score-back-button", aria: { label: t('score.back') }, onclick: "if (history.length > 1) { history.back(); return false; }" do %>
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
      </svg>
    <% end %>

    <div class="score-masthead">
      <h1 class="score-masthead-title"><%= @score.title %></h1>
      <p class="score-masthead-composer"><%= @score.composer.presence || t('score.unknown_composer') %></p>
    </div>

    <% if @score.source.present? %>
      <% source = normalize_source(@score.source) %>
      <span class="mm-badge-source mm-badge-<%= source %> score-masthead-badge">
        <%= source.upcase %>
      </span>
    <% end %>
  </header>

  <%# ═══════════════════════════════════════════════════════════════
      MAIN CONTENT: Gallery + Sidebar Grid
      ═══════════════════════════════════════════════════════════════ %>
  <div class="score-show-grid">
    <%# Gallery Column - FIRST on mobile for visual impact %>
    <div class="score-gallery-column">
      <%= render "scores/gallery", score: @score %>
    </div>

    <%# Mobile Downloads - Compact, right after gallery %>
    <% if @score.has_downloads? %>
      <div class="score-mobile-downloads">
        <%= render "scores/download_actions", score: @score, variant: :mobile %>
      </div>
    <% end %>

    <%# Sidebar Column %>
    <aside class="score-sidebar">
      <div class="score-sidebar-inner">

        <%# 1. DOWNLOADS (hidden on mobile - shown in quick actions above) %>
        <% if @score.has_downloads? %>
          <div class="mm-card p-3 sm:p-4 score-downloads-card">
            <%= render "scores/download_actions", score: @score, variant: :sidebar %>
          </div>
        <% end %>

        <%# 2. MIDI PLAYER %>
        <% if @score.has_midi? %>
          <%= render "scores/midi_player", score: @score %>
        <% end %>

        <%# 3. DESCRIPTION %>
        <% if @score.description.present? %>
          <div class="score-description">
            <p class="text-sm text-[var(--color-text-muted)] leading-relaxed italic">
              "<%= @score.description %>"
            </p>
          </div>
        <% end %>

        <%# 4. UNIFIED SCORE FACTS - 2-column grid with icons, links, difficulty meter %>
        <% facts = unified_score_facts(@score) %>
        <% if facts.any? %>
          <div class="score-facts-grid">
            <% facts.each do |fact| %>
              <% if fact[:filler] %>
                <div class="score-fact-cell"></div>
              <% elsif fact[:divider] %>
                <div class="score-facts-divider"></div>
              <% elsif fact[:difficulty] %>
                <%# Difficulty meter - special rendering %>
                <div class="score-fact-cell">
                  <span class="score-fact-label">
                    <% if fact[:icon] %><span class="score-fact-icon <%= fact[:icon_css] %>"><%= fact[:icon] %></span><% end %>
                    <%= fact[:label] %>
                  </span>
                  <%= difficulty_meter(fact[:difficulty]) %>
                </div>
              <% elsif fact[:link] %>
                <%# Linkable fact - discover more %>
                <%= link_to fact[:link], class: "score-fact-cell score-fact-cell--link" do %>
                  <span class="score-fact-label">
                    <% if fact[:icon] %><span class="score-fact-icon <%= fact[:icon_css] %>"><%= fact[:icon] %></span><% end %>
                    <%= fact[:label] %>
                    <span class="score-fact-link-arrow">→</span>
                  </span>
                  <span class="score-fact-value"><%= fact[:value] %></span>
                <% end %>
              <% else %>
                <%# Regular fact %>
                <div class="score-fact-cell">
                  <span class="score-fact-label">
                    <% if fact[:icon] %><span class="score-fact-icon <%= fact[:icon_css] %>"><%= fact[:icon] %></span><% end %>
                    <%= fact[:label] %>
                  </span>
                  <span class="score-fact-value <%= fact[:css] %>"><%= fact[:value] %></span>
                </div>
              <% end %>
            <% end %>
          </div>
        <% end %>

        <%# 5. PITCH RANGES - Visual pitch bars with C4 reference %>
        <% if has_pitch_ranges?(@score) %>
          <div class="mm-card p-3 sm:p-4">
            <%= score_section_header("♫", "score.pitch_ranges") %>
            <div class="vocal-ranges mt-4">
              <% @score.pitch_range_per_part.each do |part_name, range_data| %>
                <% range_style = pitch_range_bar_style(range_data) %>
                <div class="vocal-range-row">
                  <span class="vocal-range-part"><%= part_name %></span>
                  <div class="vocal-range-track">
                    <div class="vocal-range-bar" style="<%= range_style %>"></div>
                  </div>
                  <span class="vocal-range-notes"><%= format_part_range(range_data) %></span>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <%# 6. TAGS %>
        <% if @score.tag_list.any? %>
          <div class="score-tags-section">
            <div>
              <h3 class="score-tags-header"><%= t('score.tags') %></h3>
              <div class="score-tags-list">
                <% @score.tag_list.each do |tag| %>
                  <span class="mm-badge mm-badge-tag"><%= tag %></span>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>

        <%# 7. LYRICS (Collapsible) %>
        <% if @score.lyrics.present? %>
          <details class="mm-card overflow-hidden lyrics-accordion">
            <summary class="score-lyrics-summary">
              <%= score_section_header("¶", "score.lyrics_text") %>
              <svg class="lyrics-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"/>
              </svg>
            </summary>
            <div class="score-lyrics-content">
              <div class="lyrics-content"><%= @score.lyrics %></div>
            </div>
          </details>
        <% end %>


        <%# 9. STATS %>
        <% if @score.has_stats? %>
          <div class="score-stats">
            <% if @score.views.to_i.positive? %>
              <div class="score-stat">
                <span class="score-stat-value"><%= @score.views %></span>
                <span class="score-stat-label"><%= t('score.views') %></span>
              </div>
            <% end %>
            <% if @score.favorites.to_i.positive? %>
              <div class="score-stat">
                <span class="score-stat-value"><%= @score.favorites %></span>
                <span class="score-stat-label"><%= t('score.favs') %></span>
              </div>
            <% end %>
          </div>
        <% end %>

        <%# 10. DEV-ONLY: Extraction Debug Data %>
        <% if Rails.env.development? && has_extracted_data?(@score) %>
          <details class="mt-6 rounded-lg bg-gray-50 border border-gray-200 dark:bg-gray-800 dark:border-gray-700">
            <summary class="px-3 py-2 cursor-pointer text-xs font-mono text-gray-500 hover:text-gray-700 dark:text-gray-400">
              <%= t('score.debug_data') %> ▾
            </summary>
            <div class="p-3 border-t border-gray-200 dark:border-gray-700 overflow-x-auto">
              <pre class="text-xs font-mono text-gray-600 dark:text-gray-300 whitespace-pre-wrap"><%= JSON.pretty_generate(extraction_debug_data(@score)) %></pre>
            </div>
          </details>
        <% end %>

      </div>
    </aside>
  </div>
</div>
