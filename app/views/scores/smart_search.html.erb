<% content_for :title do %>Smart Search - ScoreBase<% end %>

<div class="max-w-4xl mx-auto px-4 sm:px-6 py-8 sm:py-12">
  <!-- Header -->
  <div class="text-center mb-8">
    <h1 class="text-2xl sm:text-3xl font-[var(--font-family-display)] font-black text-[var(--color-primary)] tracking-tight mb-2">
      Smart Search
      <% if pro_user? %>
        <span class="smart-search-pro-badge">Pro</span>
      <% end %>
    </h1>
    <p class="text-sm text-[var(--color-text-muted)]">
      Describe what you're looking for in natural language
    </p>
    <% unless pro_user? %>
      <p class="mt-2 text-sm font-bold <%= @searches_remaining.to_i <= 1 ? 'text-amber-500' : 'text-[var(--color-text-muted)]' %>">
        <% if @searches_remaining.to_i == 1 %>
          <%= t('search_limit.last_search') %>
        <% else %>
          <%= t('search_limit.searches_remaining', count: @searches_remaining.to_i) %>
        <% end %>
      </p>
    <% end %>
  </div>

  <!-- Search Form -->
  <div class="mb-8">
    <%= form_with url: smart_search_path, method: :get, class: "relative" do |f| %>
      <div class="smart-search-input-wrapper">
        <%= f.search_field :q,
            value: @query,
            placeholder: t('smart_search.placeholder'),
            class: "smart-search-input",
            autofocus: true %>
        <%= button_tag type: "submit",
            class: "smart-search-submit",
            aria: { label: t('smart_search.search_button') },
            data: { turbo_submits_with: '<svg class="smart-search-spinner" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="9" stroke-opacity="0.2"/><path d="M12 3a9 9 0 0 1 9 9"/></svg>' } do %>
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M5 12h14"></path>
            <path d="m12 5 7 7-7 7"></path>
          </svg>
        <% end %>
      </div>
    <% end %>
  </div>

  <% if @query.present? %>
    <!-- AI Summary -->
    <div class="smart-search-summary">
      <p class="smart-search-summary-text">
        <%= @rag_result.summary %>
      </p>
    </div>

    <% if @scores.any? %>
      <!-- Results -->
      <div class="smart-search-results">
        <% @scores.each_with_index do |score, index| %>
          <%= link_to score_path(score), class: "smart-search-card", data: { turbo_frame: "_top" } do %>
            <!-- Thumbnail with Rank -->
            <div class="smart-search-card-thumbnail">
              <div class="smart-search-rank"><%= index + 1 %></div>
              <%= render "scores/thumbnail", score: score %>
            </div>

            <!-- Content -->
            <div class="smart-search-card-content">
              <h2 class="smart-search-card-title">
                <%= score.title.presence || t('search.untitled') %>
              </h2>
              <% if score.composer.present? %>
                <p class="smart-search-card-composer"><%= score.composer %></p>
              <% end %>

              <% explanation = @rag_result.explanation_for(score.id) %>
              <% if explanation.present? %>
                <p class="smart-search-card-explanation"><%= explanation %></p>
              <% end %>

              <% if score.detected_instruments.present? %>
                <span class="smart-search-card-tag">
                  <%= score.detected_instruments.to_s.split(',').first&.strip %>
                </span>
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>

      <!-- Back to regular search -->
      <div class="mt-10 text-center">
        <p class="text-sm text-[var(--color-text-muted)]">
          Not finding what you need?
          <%= link_to "Try regular search", scores_path(q: @query), class: "text-[var(--color-accent)] hover:text-[var(--color-accent-hover)] font-bold ml-1 underline underline-offset-2" %>
        </p>
      </div>

    <% else %>
      <!-- No Results -->
      <div class="smart-search-empty">
        <div class="smart-search-empty-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-muted)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.3-4.3"></path>
            <path d="M8 8h6"></path>
          </svg>
        </div>
        <h3 class="text-lg font-[var(--font-family-display)] font-bold text-[var(--color-text)] mb-2">No matches found</h3>
        <p class="text-sm text-[var(--color-text-muted)] mb-5">
          Try rephrasing your search or being more specific about what you're looking for.
        </p>
        <%= link_to "Browse all scores", scores_path, class: "smart-search-browse-btn" %>
      </div>
    <% end %>

  <% else %>
    <!-- Empty State - Suggestions -->
    <div class="text-center py-6">
      <p class="text-sm text-[var(--color-text-muted)] mb-5 font-medium uppercase tracking-wide">Try asking something like:</p>
      <div class="flex flex-wrap justify-center gap-3">
        <% [
          "Easy Bach for piano students",
          "Something gentle for a church service",
          "Dramatic piece for a recital",
          "Intermediate violin sonata"
        ].each do |suggestion| %>
          <%= link_to smart_search_path(q: suggestion), class: "smart-search-suggestion" do %>
            <%= suggestion %>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
