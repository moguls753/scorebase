<% content_for :title do %>Smart Search - ScoreBase<% end %>

<div class="max-w-4xl mx-auto px-4 sm:px-6 py-8 sm:py-12">
  <!-- Header -->
  <div class="text-center mb-8">
    <h1 class="text-2xl sm:text-3xl font-[var(--font-family-display)] font-black text-[var(--color-primary)] tracking-tight uppercase">
      Smart Search
      <span class="ml-2 px-2 py-0.5 text-xs font-bold uppercase tracking-wider bg-[var(--color-accent)] text-white border-2 border-[var(--color-bg-deep)]" style="border-radius: var(--radius-sm);">Pro</span>
    </h1>
    <p class="mt-2 text-sm text-[var(--color-text-muted)]">
      Describe what you're looking for in natural language
    </p>
  </div>

  <!-- Search Form -->
  <div class="mb-8">
    <%= form_with url: smart_search_path, method: :get, local: true do %>
      <div class="flex gap-2 sm:gap-3">
        <input
          type="text"
          name="q"
          value="<%= @query %>"
          placeholder="e.g., something for my piano student who's been playing for 2 years..."
          class="mm-input flex-1 text-sm"
          autofocus
        >
        <button type="submit" class="mm-button mm-button-primary px-4" aria-label="Search">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.3-4.3"></path>
          </svg>
        </button>
      </div>
    <% end %>
  </div>

  <% if @query.present? %>
    <!-- AI Summary -->
    <div class="mb-8 p-4 bg-[var(--color-bg-card)] border-2 border-[var(--color-border)] flex items-start gap-3" style="border-radius: var(--radius-sm); box-shadow: var(--shadow-card);">
      <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-[var(--color-accent)]" style="border-radius: var(--radius-sm);">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"></path>
        </svg>
      </div>
      <p class="text-[var(--color-text)] text-sm leading-relaxed pt-1">
        <%= @rag_result.summary %>
      </p>
    </div>

    <% if @scores.any? %>
      <!-- Results -->
      <div class="space-y-5">
        <% @scores.each_with_index do |score, index| %>
          <%= link_to score_path(score), class: "smart-search-card mm-card animate-fade-in group", data: { turbo_frame: "_top", turbo_prefetch: false } do %>
            <!-- Rank Badge -->
            <div class="smart-search-rank"><%= index + 1 %></div>

            <!-- Thumbnail -->
            <div class="smart-search-thumbnail">
              <% if score.has_thumbnail? %>
                <%= image_tag score.thumbnail, alt: score.title %>
              <% else %>
                <div class="w-full h-full flex items-center justify-center text-4xl text-[var(--color-border-subtle)]">&#9835;</div>
              <% end %>
            </div>

            <!-- Content -->
            <div class="smart-search-content">
              <h2 class="text-base sm:text-lg font-[var(--font-family-display)] font-bold text-[var(--color-primary)] leading-tight group-hover:text-[var(--color-accent)] transition-colors line-clamp-2">
                <%= score.title.presence || "Untitled" %>
              </h2>

              <% if score.composer.present? %>
                <p class="mt-1 text-sm text-[var(--color-text-muted)] font-medium">
                  <%= score.composer %>
                </p>
              <% end %>

              <% explanation = @rag_result.explanation_for(score.id) %>
              <% if explanation.present? %>
                <p class="smart-search-explanation">
                  <%= explanation %>
                </p>
              <% end %>

              <div class="mt-auto pt-3 flex items-center gap-2 flex-wrap">
                <% if score.primary_key_signature.present? %>
                  <span class="mm-badge text-[10px] sm:text-[11px]"><%= score.primary_key_signature %></span>
                <% end %>
                <% if score.detected_instruments.present? %>
                  <span class="mm-badge text-[10px] sm:text-[11px]"><%= score.detected_instruments.to_s.split(',').first&.strip %></span>
                <% end %>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>

      <!-- Back to regular search -->
      <div class="mt-8 text-center">
        <p class="text-sm text-[var(--color-text-muted)]">
          Not finding what you need?
          <%= link_to "Try regular search", scores_path(q: @query), class: "text-[var(--color-accent)] hover:underline font-medium" %>
        </p>
      </div>

    <% else %>
      <!-- No Results -->
      <div class="text-center py-12">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-[var(--color-bg-surface)] border-2 border-[var(--color-border)] mb-4" style="border-radius: var(--radius-sm);">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-muted)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.3-4.3"></path>
            <path d="M8 11h6"></path>
          </svg>
        </div>
        <h3 class="text-lg font-[var(--font-family-display)] font-bold text-[var(--color-text)] mb-2 uppercase tracking-tight">No matches found</h3>
        <p class="text-sm text-[var(--color-text-muted)] mb-4">
          Try rephrasing your search or being more specific.
        </p>
        <%= link_to "Browse all scores", scores_path, class: "mm-button mm-button-secondary text-xs" %>
      </div>
    <% end %>

  <% else %>
    <!-- Empty State -->
    <div class="text-center py-8">
      <p class="text-xs text-[var(--color-text-muted)] mb-4 uppercase tracking-wide font-semibold">Try asking something like</p>
      <div class="flex flex-wrap justify-center gap-2">
        <% [
          "Easy Bach for piano students",
          "Something gentle for a church service",
          "Dramatic piece for a recital",
          "Intermediate violin sonata"
        ].each do |suggestion| %>
          <%= link_to smart_search_path(q: suggestion), class: "mm-badge hover:bg-[var(--color-bg-hover)] hover:border-[var(--color-accent)] transition-colors cursor-pointer" do %>
            <%= suggestion %>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
